dist: xenial

language: python

python: 3.7

services:
  - docker

jobs:
  include:
    - stage: test
      name: "Unit Tests and Linters"
      if: tag IS blank
      addons:
        snaps:
          - terraform
      before_install:
        - sudo service postgresql stop
        - cp .env.example .env
      install:
        - docker-compose build
      script:
        - sh scripts/lint-n-format.sh --check
        - sh scripts/test.sh
      after_success:
        - sudo mkdir /app
        - sudo cp -r project /app/project
        - pip install coveralls
        - coveralls

    - stage: deploy
      name: "Deploy to AWS"
      if: tag IS present
      addons:
        snaps:
          - name: aws-cli
            confinement: classic
      install: skip
      script: skip
      deploy:
        provider: script
        script: sh scripts/deploy.sh
        on:
          tags: true

notifications:
  email:
    on_success: never
